#!/bin/sh

# Run an experiment using tg-geolocate or similar, sending its output to a
# unique file and using 'nohup' so that exiting the session won't kill a
# background script.
#
# Allow -i STR or --id STR to be specified at the beginning of the options,
# specifying an ID to use in the outfiles.
#
# The option --run-prog can also be given at the beginning, to specify
# the name of a program other than tg-geolocate to run (e.g.
# geolocate-wikipedia).

if [ -z "$TEXTGROUNDER_DIR" ]; then
  echo "Must set TEXTGROUNDER_DIR to top level of TextGrounder distribution"
  exit 1
fi

ID=""
RUN_PROG=tg-geolocate

while true ; do
  case "$1" in
    -i | --id ) ID=".$2"; shift 2 ;;
    --run-prog ) RUN_PROG="$2"; shift 2 ;;
    * ) break ;;
  esac
done

DO_GEOLOCATE="$TEXTGROUNDER_DIR/bin/$RUN_PROG"

if [ "`uname`" = "Darwin" ]; then
  # Darwin (BSD) is missing all sorts of stuff, naturally, including %P,
  # which gets you lowercase am or pm. (%p gets you uppercase AM or PM --
  # real logical, huh?)
  OUTFILE="$RUN_PROG.out$ID.`date '+%F.%H%M%p'`"
else
  OUTFILE="$RUN_PROG.out$ID.`date '+%F.%H%M%P'`"
fi
if [ -e "$OUTFILE" ]; then
  NUM=1
  OUTFILE_BASE="$OUTFILE"
  while true ; do
    OUTFILE="$OUTFILE_BASE.$NUM"
    if [ ! -e "$OUTFILE" ]; then
      break
    fi
    NUM=`expr $NUM + 1`
  done
fi

(
echo "Nohup wrapper running on `hostname` at time `date`"
echo "Output file: $OUTFILE"
echo "Nohup script invoked as: $0" ${1+"$@"}
echo "Invoking: $DO_GEOLOCATE" ${1+"$@"}
echo "(all above info also sent to output file)"
) | tee $OUTFILE
nohup "$DO_GEOLOCATE" ${1+"$@"} >> $OUTFILE 2>&1
