#!/bin/sh

# Run 'textgrounder geolocate', passing it various useful arguments.
# Extra arguments can be specified on the command line, which will
# override any existing arguments.
#
# Various arguments to 'textgrounder' itself can be specified before other
# arguments.  These have the same names as the arguments of 'textgrounder'
# except that textgrounder's --debug is renamed --debug-jvm here because
# --debug has a different meaning for geolocate.
#
# See also 'nohup-tg-geolocate', which will run this script using 'nohup'
# while saving the output to a file.

if [ -z "$TEXTGROUNDER_DIR" ]; then
  echo "Must set TEXTGROUNDER_DIR to top level of TextGrounder distribution"
  exit 1
fi

. $TEXTGROUNDER_DIR/bin/config-geolocate

# Option processing

TGOPTS=
while true ; do
  case "$1" in
    -minheap | --minheap ) TGOPTS="$TGOPTS --minheap $2"; shift 2 ;;
    -maxheap | --maxheap ) TGOPTS="$TGOPTS --maxheap $2"; shift 2 ;;
    -memory | --memory ) TGOPTS="$TGOPTS --memory $2"; shift 2 ;;
    -escape-analysis | --escape-analysis )
      TGOPTS="$TGOPTS --escape-analysis"; shift ;;
    -compressed-oops | --compressed-oops )
      TGOPTS="$TGOPTS --compressed-oops"; shift ;;
    -verbose | --verbose ) TGOPTS="$TGOPTS --verbose"; shift ;;
    -debug-jvm | --debug-jvm ) TGOPTS="$TGOPTS --debug"; shift ;;
    -- ) shift ; break ;;
    * ) break ;;
  esac
done

GEOLOCATE="$TEXTGROUNDER_DIR/bin/textgrounder $TGOPTS geolocate"

MODE=geotag-documents
sawmode=no
# Only look for mode statements for toponyms.
for x in ${1+"$@"}; do
  if [ "$x" = "--mode=geotag-toponyms" ]; then
    MODE=geotag-toponyms
  elif [ "$sawmode" = yes -a "$x" = "geotag-toponyms" ]; then
    MODE=geotag-toponyms
  fi
  if [ "$x" = "--mode" -o "$x" = "-m" ]; then
    sawmode=yes
  else
    sawmode=no
  fi
done

if [ "$MODE" = "geotag-toponyms" ]; then
  STRATEGY="--strategy baseline"
  #STRATEGY="--strategy naive-bayes-with-baseline"
  #STRATEGY="--strategy naive-bayes-no-baseline"
  #MISCOPTS="$MISCOPTS --naive-bayes-weighting distance-weighted"
  EVALFILE="--eval-file $TRCONLL_DEV_DIR"
  EVALTYPE="--eval-format tr-conll"
  #EVALFILE="--eval-file $PREFIX-toponym-eval.txt"
  MODE_ARG="$GAZETTEER_ARG $STRATEGY $EVALFILE $EVALTYPE"
else
  MODE_ARG=
fi

# TG_EXTRA_ARGS are used to pass arguments down from front-end programs
# without interfering with the options passed in and meant to be handled
# by us.
echo Executing: $GEOLOCATE $MODE_ARG $MISCOPTS $LOCAL_ARGS $TG_EXTRA_ARGS ${1+"$@"}
$GEOLOCATE $MODE_ARG $MISCOPTS $LOCAL_ARGS $TG_EXTRA_ARGS ${1+"$@"}
